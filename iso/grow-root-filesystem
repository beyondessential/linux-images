#!/bin/bash
set -euo pipefail

VARIANT=$(cat /etc/bes/image-variant 2>/dev/null || echo "metal-encrypted")

DISK=/dev/$(lsblk -ndo PKNAME /dev/disk/by-partlabel/root)
PART_NUM=$(lsblk -ndo KNAME /dev/disk/by-partlabel/root | grep -o '[0-9]*$')

sgdisk --move-second-header "$DISK"
partprobe "$DISK" || true
fdisk -l "$DISK"

if growpart --free-percent=1 "$DISK" "$PART_NUM"; then
  echo "Partition grown successfully"
elif [ $? -eq 1 ]; then
  echo "No change needed"
  exit 0
else
  exit $?
fi

set -x
partprobe "$DISK" || true

if [ "$VARIANT" = "metal-encrypted" ]; then
  cryptsetup resize root
fi

btrfs filesystem resize max /
fdisk -l "$DISK"
