#cloud-config
{"version":1,"source":{"id":"ubuntu-server-minimal"},"interactive":{"sections":["network","identity"]},"locale":"en_US.UTF-8","keyboard":{"layout":"us"},"timezone":"Etc/UTC","ssh":{"install-server":true,"allow-pw":false},"storage":{"layout":{"name":"custom","config":[{"type":"disk","id":"disk0","ptable":"gpt","grub_device":true},{"type":"partition","id":"efi","device":"disk0","size":"512M","flag":"boot"},{"type":"partition","id":"boot","device":"disk0","size":"1G"},{"type":"partition","id":"staging","device":"disk0","size":"4G"},{"type":"partition","id":"root","device":"disk0","size":-1},{"type":"format","id":"efi-fmt","volume":"efi","fstype":"fat32"},{"type":"format","id":"boot-fmt","volume":"boot","fstype":"ext4"},{"type":"format","id":"staging-fmt","volume":"staging","fstype":"ext4"},{"type":"mount","id":"efi-mnt","device":"efi-fmt","path":"/boot/efi"},{"type":"mount","id":"boot-mnt","device":"boot-fmt","path":"/boot"},{"type":"mount","id":"staging-mnt","device":"staging-fmt","path":"/"}]}},"packages":["btrfs-progs","cryptsetup","cloud-init","cloud-initramfs-growroot","linux-generic","grub-pc","grub-efi-amd64","grub-efi-arm64","openssh-server","netplan.io","curl","wget","bind9-dnsutils","vim","tmux","htop","ncdu","jq","tree","ripgrep","systemd-journal-remote","rsyslog","ufw","fail2ban","unattended-upgrades","git","build-essential","awscli","ec2-instance-connect","zstd"],"user-data":{"disable_root":true,"package_update":true,"package_upgrade":true},"late-commands":["curtin in-target -- bash /tmp/migrate-to-btrfs.sh","cat > /target/tmp/migrate-to-btrfs.sh << 'EOFMIGRATE'\n#!/bin/bash\nset -ex\n\n# Migration script to move installed system from staging partition to BTRFS root\n# This runs in the autoinstall late-commands phase\n\n# Find partitions\nDISK=$(lsblk -ndo PKNAME $(findmnt -n -o SOURCE /))\nROOT_PART=\"/dev/$(lsblk -ln -o NAME,PARTLABEL | grep 'root' | awk '{print $1}')\"\nSTAGING_PART=$(findmnt -n -o SOURCE /)\nBOOT_PART=\"/dev/$(lsblk -ln -o NAME,PARTLABEL | grep 'boot' | awk '{print $1}' | head -1)\"\nEFI_PART=\"/dev/$(lsblk -ln -o NAME,PARTLABEL | grep 'efi' | awk '{print $1}')\"\n\necho \"Disk: $DISK\"\necho \"Root partition: $ROOT_PART\"\necho \"Staging partition: $STAGING_PART\"\necho \"Boot partition: $BOOT_PART\"\necho \"EFI partition: $EFI_PART\"\n\n# Generate LUKS passphrase (6 words from /usr/share/dict/words)\necho \"Generating LUKS encryption passphrase...\"\nif [ -f /usr/share/dict/words ]; then\n  LUKS_PASSPHRASE=$(grep -E '^[a-z]{4,8}$' /usr/share/dict/words | shuf -n 6 | tr '\\n' '-' | sed 's/-$//')\nelse\n  # Fallback if wordlist not available\n  LUKS_PASSPHRASE=$(openssl rand -base64 32)\nfi\necho \"$LUKS_PASSPHRASE\" > /tmp/luks-passphrase\n\n# Display passphrase to user\nchvt 1\nclear\necho \"\"\necho \"==========================================\"\necho \"DISK ENCRYPTION PASSPHRASE\"\necho \"==========================================\"\necho \"\"\necho \"Your disk encryption passphrase:\"\necho \"\"\necho \"$LUKS_PASSPHRASE\"\necho \"\"\necho \"This will be saved to ~/luks-passphrase.txt\"\necho \"IMPORTANT: Keep this safe! You may need it if disk unlock fails.\"\necho \"\"\necho \"Press Enter to continue installation...\"\nread\nchvt 2\n\n# Setup LUKS encryption on root partition\necho \"Setting up LUKS encryption...\"\necho -n \"$LUKS_PASSPHRASE\" | cryptsetup luksFormat --type luks2 $ROOT_PART -\necho -n \"$LUKS_PASSPHRASE\" | cryptsetup open $ROOT_PART root-crypt -\n\n# Create keyfile on boot partition for automatic unlock\necho \"Creating keyfile for automatic unlock...\"\nKEYFILE_PATH=\"/mnt/boot-keyfile\"\nmkdir -p $KEYFILE_PATH\nmount $BOOT_PART $KEYFILE_PATH\necho -n \"$LUKS_PASSPHRASE\" > $KEYFILE_PATH/luks-keyfile.key\nchmod 000 $KEYFILE_PATH/luks-keyfile.key\n\n# Add keyfile to LUKS\necho -n \"$LUKS_PASSPHRASE\" | cryptsetup luksAddKey $ROOT_PART $KEYFILE_PATH/luks-keyfile.key -\n\numount $KEYFILE_PATH\nrmdir $KEYFILE_PATH\n\n# Use the opened LUKS device\nLUKS_DEV=\"/dev/mapper/root-crypt\"\n\n# Format LUKS container as BTRFS with features enabled\necho \"Creating BTRFS filesystem with features...\"\nmkfs.btrfs -f -L ROOT --features block-group-tree,squota $LUKS_DEV\n\n# Mount and create subvolumes\nmkdir -p /mnt/newroot\nmount $LUKS_DEV /mnt/newroot\n\necho \"Creating BTRFS subvolumes...\"\nbtrfs subvolume create /mnt/newroot/@\nbtrfs subvolume create /mnt/newroot/@home\nbtrfs subvolume create /mnt/newroot/@logs\nbtrfs subvolume create /mnt/newroot/@postgres\nbtrfs subvolume create /mnt/newroot/@containers\nbtrfs subvolume create /mnt/newroot/snapshots\n\n# Enable quotas\necho \"Enabling quotas...\"\nbtrfs quota enable /mnt/newroot\n\n# Copy system from staging to BTRFS subvolumes\necho \"Copying system to BTRFS subvolumes...\"\nrsync -aAX \\\n  --exclude=/mnt \\\n  --exclude=/tmp/* \\\n  --exclude=/proc/* \\\n  --exclude=/sys/* \\\n  --exclude=/dev/* \\\n  --exclude=/home \\\n  --exclude=/var/log \\\n  / /mnt/newroot/@/\n\n# Copy home\nif [ -d /home ] && [ \"$(ls -A /home 2>/dev/null)\" ]; then\n  echo \"Copying /home...\"\n  rsync -aAX /home/ /mnt/newroot/@home/\nfi\n\n# Copy logs\nif [ -d /var/log ] && [ \"$(ls -A /var/log 2>/dev/null)\" ]; then\n  echo \"Copying /var/log...\"\n  rsync -aAX /var/log/ /mnt/newroot/@logs/\nfi\n\n# Create directories for other subvolumes\nmkdir -p /mnt/newroot/@/var/lib/postgresql\nmkdir -p /mnt/newroot/@/var/lib/containers\n\n# Set @ as default subvolume\necho \"Setting default subvolume...\"\nDEFAULT_ID=$(btrfs subvolume list /mnt/newroot | grep '@$' | awk '{print $2}')\nbtrfs subvolume set-default $DEFAULT_ID /mnt/newroot\n\n# Get UUIDs\nLUKS_UUID=$(blkid -s UUID -o value $ROOT_PART)\nROOT_UUID=$(blkid -s UUID -o value $LUKS_DEV)\nBOOT_UUID=$(blkid -s UUID -o value $BOOT_PART)\nEFI_UUID=$(blkid -s UUID -o value $EFI_PART)\nSTAGING_UUID=$(blkid -s UUID -o value $STAGING_PART)\n\necho \"UUIDs:\"\necho \"  LUKS: $LUKS_UUID\"\necho \"  Root: $ROOT_UUID\"\necho \"  Boot: $BOOT_UUID\"\necho \"  EFI: $EFI_UUID\"\necho \"  Staging: $STAGING_UUID\"\n\n# Create fstab in new root\necho \"Creating /etc/fstab...\"\ncat > /mnt/newroot/@/etc/fstab << EOF\n# /etc/fstab: static file system information\nUUID=$ROOT_UUID /                       btrfs subvol=@,compress=zstd:6 0 1\nUUID=$ROOT_UUID /home                   btrfs subvol=@home,compress=zstd:6 0 2\nUUID=$ROOT_UUID /var/log                btrfs subvol=@logs,compress=zstd:6 0 2\nUUID=$ROOT_UUID /var/lib/postgresql     btrfs subvol=@postgres,compress=zstd:6 0 2\nUUID=$ROOT_UUID /var/lib/containers     btrfs subvol=@containers,compress=zstd:6 0 2\nUUID=$BOOT_UUID /boot                   ext4 defaults 0 2\nUUID=$EFI_UUID /boot/efi                vfat umask=0077 0 1\n/dev/mapper/swap none                   swap sw 0 0\nEOF\n\n# Setup encrypted swap configuration\necho \"Configuring encrypted swap...\"\ncat > /mnt/newroot/@/etc/crypttab << EOF\n# /etc/crypttab: mappings for encrypted partitions\nroot-crypt UUID=$LUKS_UUID /boot/luks-keyfile.key luks,discard,keyscript=/bin/cat\nswap UUID=$STAGING_UUID /dev/urandom swap,cipher=aes-xts-plain64,size=256\nEOF\n\n# Update grub to boot from new root\necho \"Updating bootloader...\"\nmount --bind /dev /mnt/newroot/@/dev\nmount --bind /proc /mnt/newroot/@/proc\nmount --bind /sys /mnt/newroot/@/sys\nmount $BOOT_PART /mnt/newroot/@/boot\nmount $EFI_PART /mnt/newroot/@/boot/efi\n\n# Update initramfs and grub\necho \"Running update-initramfs...\"\nchroot /mnt/newroot/@ update-initramfs -u -k all\n\necho \"Running update-grub...\"\nchroot /mnt/newroot/@ update-grub\n\necho \"Installing GRUB...\"\nchroot /mnt/newroot/@ grub-install --target=x86_64-efi --efi-directory=/boot/efi --bootloader-id=ubuntu --recheck || echo \"WARNING: grub-install failed\"\n\n# Unmount everything\necho \"Unmounting filesystems...\"\numount /mnt/newroot/@/boot/efi || true\numount /mnt/newroot/@/boot || true\numount /mnt/newroot/@/sys || true\numount /mnt/newroot/@/proc || true\numount /mnt/newroot/@/dev || true\numount /mnt/newroot || true\nrmdir /mnt/newroot || true\n\n# Save passphrase to user's home directory\nDEFAULT_USER=$(ls /mnt/newroot/@home 2>/dev/null | head -1)\nif [ -n \"$DEFAULT_USER\" ]; then\n  echo \"Saving passphrase to /home/$DEFAULT_USER/luks-passphrase.txt...\"\n  cp /tmp/luks-passphrase /mnt/newroot/@home/$DEFAULT_USER/luks-passphrase.txt\n  chroot /mnt/newroot/@ chown $DEFAULT_USER:$DEFAULT_USER /home/$DEFAULT_USER/luks-passphrase.txt\n  chroot /mnt/newroot/@ chmod 600 /home/$DEFAULT_USER/luks-passphrase.txt\nfi\n\n# Setup TPM enrollment script\ncat > /mnt/newroot/@/usr/local/bin/setup-tpm-unlock << EOFTPM\n#!/bin/bash\nset -e\n\nLUKS_UUID=\"$LUKS_UUID\"\nKEYFILE=\"/boot/luks-keyfile.key\"\n\nif [ -e /dev/tpmrm0 ] || [ -e /dev/tpm0 ]; then\n  echo \"TPM2 device found, enrolling for automatic unlock...\"\n  if [ -f /tmp/luks-passphrase ]; then\n    systemd-cryptenroll --tpm2-device=auto --tpm2-pcrs=7 /dev/disk/by-uuid/\\$LUKS_UUID < /tmp/luks-passphrase\n    echo \"TPM2 enrolled successfully with PCR 7!\"\n\n    # Remove keyfile from LUKS and securely delete it\n    echo \"Removing keyfile from LUKS...\"\n    cryptsetup luksRemoveKey /dev/disk/by-uuid/\\$LUKS_UUID \\$KEYFILE\n\n    # Secure delete keyfile\n    echo \"Securely deleting keyfile...\"\n    shred -vfz -n 3 \\$KEYFILE\n    rm -f \\$KEYFILE\n\n    # Update crypttab to remove keyfile reference\n    sed -i \"s|root-crypt UUID=\\$LUKS_UUID /boot/luks-keyfile.key luks,discard,keyscript=/bin/cat|root-crypt UUID=\\$LUKS_UUID none luks,discard|\" /etc/crypttab\n\n    echo \"Keyfile removed. System will auto-unlock via TPM on next boot.\"\n    rm -f /tmp/luks-passphrase\n  else\n    echo \"WARNING: Could not find passphrase file, skipping TPM enrollment\"\n  fi\nelse\n  echo \"No TPM2 device found. System will use keyfile at \\$KEYFILE for auto-unlock.\"\n  echo \"Passphrase fallback available if keyfile is unavailable.\"\n  rm -f /tmp/luks-passphrase\nfi\nEOFTPM\n\nchmod +x /mnt/newroot/@/usr/local/bin/setup-tpm-unlock\n\n# Create systemd service for TPM enrollment\ncat > /mnt/newroot/@/etc/systemd/system/setup-tpm-unlock.service << 'EOFTPMSVC'\n[Unit]\nDescription=Setup TPM2 auto-unlock for LUKS\nAfter=local-fs.target\nBefore=tailscale-first-boot.service\nConditionPathExists=!/etc/tpm-enrolled\n\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/setup-tpm-unlock\nExecStartPost=/usr/bin/touch /etc/tpm-enrolled\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target\nEOFTPMSVC\n\n# Enable TPM enrollment service\nchroot /mnt/newroot/@ systemctl enable setup-tpm-unlock.service\n\n# Copy passphrase for TPM enrollment on first boot\ncp /tmp/luks-passphrase /mnt/newroot/@/tmp/luks-passphrase 2>/dev/null || true\n\necho \"Migration complete! System will boot from encrypted BTRFS root with TPM unlock.\"\n\nEOFMIGRATE","curtin in-target -- bash /tmp/setup-firewall.sh","cat > /target/tmp/setup-firewall.sh << 'EOFFIREWALL'\n#!/bin/bash\nset -euo pipefail\n\n# UFW firewall configuration script\n# Sets up basic firewall rules for web services and SSH\n\necho \"Configuring UFW firewall...\"\n\n# Reset UFW to clean state\nufw --force reset\n\n# Set default policies\nufw default deny incoming\nufw default allow outgoing\nufw default allow forward\n\n# Allow SSH from anywhere (will be restricted after Tailscale connects)\nufw allow 22/tcp comment 'SSH'\n\n# Allow HTTP/HTTPS\nufw allow 80/tcp comment 'HTTP'\nufw allow 443/tcp comment 'TCP HTTPS'\nufw allow 443/udp comment 'UDP HTTPS (HTTP/3)'\n\n# Allow ICMP (ping) for IPv4 and IPv6\nufw allow proto icmp comment 'ICMP ping'\nufw allow proto ipv6-icmp comment 'ICMPv6 ping'\n\n# Enable UFW\nufw --force enable\n\necho \"UFW firewall configured\"\necho \"Rules:\"\necho \"  - SSH (22/tcp): allowed from anywhere\"\necho \"  - HTTP (80/tcp): allowed\"\necho \"  - HTTPS (443/tcp+udp): allowed\"\necho \"  - ICMP ping: allowed\"\n\nEOFFIREWALL","cp /cdrom/pool/extras/tailscale.deb /target/tmp/tailscale.deb || true","base64 -d > /target/tmp/tailscale-apt.gpg << 'EOFGPG'\n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\nEOFGPG","curtin in-target -- bash /tmp/setup-tailscale.sh","cat > /target/tmp/setup-tailscale.sh << 'EOFTAILSCALE'\n#!/bin/bash\nset -euo pipefail\n\n# Tailscale installation script\n# Matches the setup in ansible/roles/tailscale\n\necho \"Installing Tailscale...\"\n\n# Check if local .deb package is available (from ISO or provisioner)\nif [ -f /tmp/tailscale.deb ]; then\n  echo \"Installing Tailscale from local package...\"\n  dpkg -i /tmp/tailscale.deb || apt-get install -f -y\nelse\n  echo \"Installing Tailscale from repository...\"\n\n  # Copy Tailscale GPG key from repository\n  # This should be copied to /tmp/tailscale-apt.gpg by the provisioner\n  if [ -f /tmp/tailscale-apt.gpg ]; then\n    cp /tmp/tailscale-apt.gpg /usr/share/keyrings/tailscale-archive-keyring.gpg\n  else\n    echo \"WARNING: /tmp/tailscale-apt.gpg not found, downloading from web\"\n    curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/noble.noarmor.gpg | tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null\n  fi\n\n  # Add Tailscale repository\n  echo \"deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu noble main\" | tee /etc/apt/sources.list.d/tailscale.list\n\n  # Prioritise tailscale repo\n  cat > /etc/apt/preferences.d/99-tailscale << 'EOF'\nPackage: *\nPin: release o=pkgs.tailscale.com\nPin-Priority: 900\nEOF\n\n  # Update package cache\n  apt-get update\n\n  # Install tailscale\n  apt-get install -y tailscale\nfi\n\n# Enable and start tailscaled service\nsystemctl enable tailscaled\nsystemctl start tailscaled\n\n# Set up auto-upgrade via cron\ncat > /etc/cron.weekly/apt-upgrade-tailscale << 'EOF'\n#!/bin/sh\napt install -y tailscale\nEOF\nchmod 0755 /etc/cron.weekly/apt-upgrade-tailscale\n\necho \"Tailscale installed successfully\"\necho \"To connect to Tailscale network, run: tailscale up\"\n\nEOFTAILSCALE","cat > /target/etc/systemd/system/tailscale-first-boot.service << 'EOFTSSERVICE'\n[Unit]\nDescription=Tailscale first boot configuration\nAfter=tailscaled.service network-online.target\nWants=network-online.target\nConditionPathExists=!/etc/tailscale-configured\n\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/tailscale-first-boot\nStandardInput=tty\nStandardOutput=tty\nRemainAfterExit=yes\nTimeoutStartSec=300\n\n[Install]\nWantedBy=multi-user.target\n\nEOFTSSERVICE","cat > /target/usr/local/bin/tailscale-first-boot << 'EOFTSBOOT'\n#!/bin/bash\nset -e\n\n# Tailscale first boot configuration script\n# Prompts user to provide Tailscale auth key and connects to network\n\necho \"\"\necho \"==========================================\"\necho \"Tailscale Configuration\"\necho \"==========================================\"\necho \"\"\necho \"Enter your Tailscale auth key (or press Enter to skip):\"\nread -r TS_AUTH_KEY\n\nTAILSCALE_CONNECTED=0\n\nif [ -n \"$TS_AUTH_KEY\" ]; then\n  echo \"Connecting to Tailscale with auth key...\"\n  if tailscale up --auth-key=\"$TS_AUTH_KEY\" --ssh; then\n    echo \"Tailscale configured successfully!\"\n    touch /etc/tailscale-configured\n    TAILSCALE_CONNECTED=1\n  else\n    echo \"WARNING: Failed to connect to Tailscale\"\n    echo \"You can try again later with: tailscale up --ssh --qr\"\n  fi\nelse\n  echo \"\"\n  echo \"No auth key provided. Starting interactive login...\"\n  echo \"Scan the QR code below with your Tailscale app:\"\n  echo \"\"\n  if tailscale up --ssh --qr; then\n    echo \"\"\n    echo \"Tailscale configured successfully!\"\n    touch /etc/tailscale-configured\n    TAILSCALE_CONNECTED=1\n  else\n    echo \"\"\n    echo \"WARNING: Failed to connect to Tailscale\"\n    echo \"You can try again later with: tailscale up --ssh --qr\"\n  fi\nfi\n\n# Restrict SSH to LAN and Tailscale if connection was successful\nif [ $TAILSCALE_CONNECTED -eq 1 ]; then\n  echo \"\"\n  echo \"Restricting SSH access to LAN and Tailscale...\"\n\n  # Remove general SSH rule\n  ufw delete allow 22/tcp\n\n  # Allow SSH from private network ranges (RFC1918)\n  ufw allow from 10.0.0.0/8 to any port 22 proto tcp comment 'SSH from LAN'\n  ufw allow from 172.16.0.0/12 to any port 22 proto tcp comment 'SSH from LAN'\n  ufw allow from 192.168.0.0/16 to any port 22 proto tcp comment 'SSH from LAN'\n\n  # Allow SSH from IPv6 ULA\n  ufw allow from fc00::/7 to any port 22 proto tcp comment 'SSH from LAN (IPv6)'\n\n  # Allow SSH from Tailscale interface\n  ufw allow in on tailscale0 to any port 22 proto tcp comment 'SSH from Tailscale'\n\n  ufw reload\n\n  echo \"SSH access restricted to LAN and Tailscale networks.\"\nfi\n\n# Disable this service after first run\nsystemctl disable tailscale-first-boot.service\n\nEOFTSBOOT","chmod +x /target/usr/local/bin/tailscale-first-boot","curtin in-target -- systemctl enable tailscale-first-boot.service","curtin in-target -- systemctl enable ssh"]}
